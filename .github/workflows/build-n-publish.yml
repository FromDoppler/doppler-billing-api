name: Build and publish Windows-based Docker image

on:

  push:
    branches:
      - master
      - INT
      - PRODTEST
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
  pull_request:

jobs:

  verify:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Verify code format (requires Linux containers)
      run: docker build --file Dockerfile.verify .

  build:
    runs-on: windows-2019
    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"
    - name: Dump job context
      env:
        JOB_CONTEXT: ${{ toJson(job) }}
      run: echo "$JOB_CONTEXT"
    - name: Dump steps context
      env:
        STEPS_CONTEXT: ${{ toJson(steps) }}
      run: echo "$STEPS_CONTEXT"
    - name: Dump runner context
      env:
        RUNNER_CONTEXT: ${{ toJson(runner) }}
      run: echo "$RUNNER_CONTEXT"
    - name: Dump strategy context
      env:
        STRATEGY_CONTEXT: ${{ toJson(strategy) }}
      run: echo "$STRATEGY_CONTEXT"
    - name: Dump matrix context
      env:
        MATRIX_CONTEXT: ${{ toJson(matrix) }}
      run: echo "$MATRIX_CONTEXT"
    - uses: actions/checkout@v2
    - name: Publish pull request
      if: ${{ github.event_name == 'pull_request' }}
      env:
        DOCKER_WRITTER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKER_WRITTER_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      # By the moment it is building the merge commit, so github.sha is not a
      # commit in the PR branch
      run: bash ./build-n-publish.sh --commit=${{ github.sha }} --name=pr-${{ github.event.number }} --platform=windows
    - name: Publish PRODTEST
      if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/PRODTEST' }}
      env:
        DOCKER_WRITTER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKER_WRITTER_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      run: bash ./build-n-publish.sh --commit=${{ github.sha }} --name=PRODTEST --platform=windows
    - name: Publish INT
      if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/INT' }}
      env:
        DOCKER_WRITTER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKER_WRITTER_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      run: bash ./build-n-publish.sh --commit=${{ github.sha }} --name=INT --platform=windows
    - name: Publish master
      if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
      env:
        DOCKER_WRITTER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKER_WRITTER_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      run: bash ./build-n-publish.sh --commit=${{ github.sha }} --name=master --platform=windows
    - name: Publish final version images
      if: ${{ github.event_name == 'push' && startsWith(github.ref,'refs/tags/v') }}
      env:
        DOCKER_WRITTER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKER_WRITTER_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
        GIT_REF: ${{ github.ref }}
      run: bash ./build-n-publish.sh --commit=${{ github.sha }} --platform=windows
